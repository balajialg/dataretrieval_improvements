name: Data Retrieval Dispatcher

# Add permissions at workflow level
permissions:
  issues: write
  contents: read

on:
  issues:
    types: [opened, labeled]

jobs:
  label_check:
    name: Check if data retrieval label exists
    runs-on: ubuntu-latest
    outputs:
      should_process: ${{ steps.check.outputs.should_process }}
    steps:
      - name: Check for data retrieval label
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const labels = context.payload.issue.labels.map(label => label.name);
            const hasDataRetrievalLabel = labels.includes('data retrieval');
            core.setOutput('should_process', hasDataRetrievalLabel);
            core.info(`Has data retrieval label: ${hasDataRetrievalLabel}`);
            return hasDataRetrievalLabel;

  handle_issue:
    name: Extract issue data and prepare for processing
    runs-on: ubuntu-latest
    needs: label_check
    if: needs.label_check.outputs.should_process == 'true'
    outputs:
      receiver_email: ${{ steps.extract.outputs.receiver_email }}
      extracted_link: ${{ steps.extract.outputs.extracted_link }}
      issue_url: ${{ steps.extract.outputs.issue_url }}
    steps:
      - name: Extract information from issue
        id: extract
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const issueBody = issue.body || '';
            
            // Extract email address
            const emailMatch = issueBody.match(/###\s*Your UC Berkeley Email Address\s*\n\s*([^\n]+@[^\n]+)/i);
            const email = emailMatch ? emailMatch[1].trim() : '';
            
            // Extract DataHub folder link
            const linkMatch = issueBody.match(/###\s*Link to Your Datahub Folder\s*\n\s*(gs:\/\/[^\n]+)/i);
            const link = linkMatch ? linkMatch[1].trim() : '';
            
            // Get issue URL
            const issueUrl = issue.html_url;
            
            core.info(`Extracted email: ${email}`);
            core.info(`Extracted link: ${link}`);
            core.info(`Issue URL: ${issueUrl}`);
            
            core.setOutput('receiver_email', email);
            core.setOutput('extracted_link', link);
            core.setOutput('issue_url', issueUrl);

  # DISABLED FOR TESTING - Email sending workflow
  # Uncomment when secrets are configured: GCP_SERVICE_ACCOUNT_KEY, TOKEN_PICKLE
  # process_requests:
  #   name: Process data retrieval request
  #   runs-on: ubuntu-latest
  #   needs: handle_issue
  #   if: needs.handle_issue.outputs.receiver_email != '' && needs.handle_issue.outputs.extracted_link != ''
  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@v4
  #
  #     - name: Set up Python
  #       uses: actions/setup-python@v5
  #       with:
  #         python-version: '3.11'
  #
  #     - name: Install dependencies
  #       run: |
  #         pip install google-api-python-client google-auth-oauthlib google-cloud-storage requests
  #
  #     - name: Run data retrieval and email script
  #       env:
  #         RECEIVER_EMAIL: ${{ needs.handle_issue.outputs.receiver_email }}
  #         EXTRACTED_LINK: ${{ needs.handle_issue.outputs.extracted_link }}
  #         ISSUE_URL: ${{ needs.handle_issue.outputs.issue_url }}
  #         GCP_SERVICE_ACCOUNT_KEY: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
  #         TOKEN_PICKLE: ${{ secrets.TOKEN_PICKLE }}
  #         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  #       run: |
  #         python .github/scripts/sign_url_and_send_emails.py
  #
  #     - name: Close issue after processing
  #       if: success()
  #       uses: actions/github-script@v7
  #       with:
  #         script: |
  #           const issueNumber = context.payload.issue.number;
  #           await github.rest.issues.update({
  #             owner: context.repo.owner,
  #             repo: context.repo.repo,
  #             issue_number: issueNumber,
  #             state: 'closed'
  #           });

  # TEST MODE - Skip email sending but do FERPA redaction and close issue
  test_validation:
    name: Test - Validate, redact email (FERPA), and close issue
    runs-on: ubuntu-latest
    needs: handle_issue
    if: needs.handle_issue.outputs.receiver_email != '' && needs.handle_issue.outputs.extracted_link != ''
    steps:
      - name: Validate extracted data
        run: |
          echo "‚úÖ Successfully extracted data from issue:"
          echo "  Email: ${{ needs.handle_issue.outputs.receiver_email }}"
          echo "  Link: ${{ needs.handle_issue.outputs.extracted_link }}"
          echo "  Issue URL: ${{ needs.handle_issue.outputs.issue_url }}"
          echo ""
          echo "‚ö†Ô∏è  EMAIL WORKFLOW DISABLED FOR TESTING"
          echo "‚ö†Ô∏è  Proceeding with FERPA redaction and issue closure"

      - name: Redact email from issue body (FERPA compliance)
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.payload.issue.number;
            
            // Get current issue
            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });
            
            // Redact email addresses from body
            const emailPattern = /\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g;
            const redactedBody = issue.body.replace(emailPattern, '[REDACTED FOR FERPA COMPLIANCE]');
            
            // Update issue with redacted body
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: redactedBody
            });
            
            core.info('Successfully redacted email addresses from issue body');

      - name: Comment on issue (TEST MODE)
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.payload.issue.number;
            const link = '${{ needs.handle_issue.outputs.extracted_link }}';
            
            const comment = `### ‚ö†Ô∏è Test Mode - Email Workflow Disabled
            
            **Your data retrieval request has been processed (TEST MODE):**
            - üìÅ Archived file location: \`${link}\`
            - ‚úÖ Email address has been redacted for FERPA compliance
            
            **Note:** Email sending is currently disabled for testing. In production mode, you would receive an email with signed URLs to download your archived files.
            
            This issue is being automatically closed.`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: comment
            });

      - name: Close issue
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.payload.issue.number;
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              state: 'closed'
            });
            core.info('Issue closed successfully');
